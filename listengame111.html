<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Signpost Challenge</title>
    <style>
        /* CSS æ ·å¼ï¼šç¡®ä¿é¡µé¢ç®€æ´å’Œåé¦ˆæ˜ç¡® */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            transition: background-color 0.5s;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        h1 {
            color: #007bff;
            margin-bottom: 20px;
        }

        .mode-selection button, #trafficActionButton, #submitAnswer {
            padding: 12px 25px;
            font-size: 1.1em;
            margin: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            color: white;
            font-weight: bold;
        }

        .mode-selection button {
            background-color: #28a745;
        }

            .mode-selection button:hover {
                background-color: #1e7e34;
            }

        /* å…³å¡çŠ¶æ€ */
        #statusMessage {
            font-size: 1.5em;
            min-height: 40px;
            margin: 20px 0;
            font-weight: bold;
        }
        /* çº¢ç»¿ç¯æ¨¡å¼æŒ‰é’®æ ·å¼ */
        #trafficActionButton {
            background-color: #ffc107;
            color: #333;
        }

            #trafficActionButton:hover:not(:disabled) {
                background-color: #e0a800;
            }

            #trafficActionButton:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }

        /* å¹¿æ’­æ¨¡å¼æ ·å¼ */
        #broadcastInput {
            padding: 10px;
            width: 80%;
            margin: 15px 0;
            border: 2px solid #ccc;
            border-radius: 5px;
        }

        #broadcastControls button {
            background-color: #6c757d;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            margin: 5px;
        }

        /* æˆåŠŸ/å¤±è´¥åé¦ˆ */
        .success {
            background-color: #e6ffe6;
            border: 2px solid #28a745;
            color: #28a745;
        }

        .failure {
            background-color: #ffe6e6;
            border: 2px solid #dc3545;
            color: #dc3545;
        }

        /* éšè—åŒºåŸŸ */
        .hidden {
            display: none;
        }

        .level-selection button {
            background-color: #007bff;
            margin: 5px;
        }

        .admin-link {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.9em;
            color: #007bff;
            cursor: pointer;
        }

        .admin-section input {
            padding: 5px;
            margin: 5px 0;
            width: 90%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-link" onclick="toggleAdminPanel()">ç®¡ç†å‘˜é…ç½®</div>

        <div id="mainContent">
            <h1>ğŸ§ Sound Signpost Challenge</h1>
            <p>Select a mode and complete the challenge using auditory cues only!</p>

            <div id="modeSelection" class="mode-selection">
                <button onclick="showTrafficLightMode()">Traffic Light Mode</button>
                <button onclick="showBroadcastMode()">Broadcast Mode</button>
            </div>

            <div id="trafficLightMode" class="hidden">
                <h2>ğŸš¥ Traffic Light Mode</h2>
                <div id="trafficLevelSelection">
                    <p>Select Difficulty Level:</p>
                    <button onclick="startTrafficLightGame('level1')">Level 1 (Clear)</button>
                    <button onclick="startTrafficLightGame('level2')">Level 2 (Traffic Only)</button>
                    <button onclick="startTrafficLightGame('level3')">Level 3 (Noisy/Chaotic)</button>
                    <p><small>Goal: Listen and click the button during the correct time slot.</small></p>
                </div>

                <div id="trafficGame" class="hidden">
                    <div id="statusMessage">Ready...</div>
                    <button id="trafficActionButton" onclick="attemptPass()">Click to Pass</button>
                    <p><small>Current Audio: <span id="currentAudioName"></span></small></p>
                </div>

                <button class="controls" onclick="showModeSelection()">Return to Mode Selection</button>
            </div>

            <div id="broadcastMode" class="hidden">
                <h2>ğŸ”Š Broadcast Mode</h2>
                <p>Listen repeatedly to the announcement and type what you hear.</p>
                <div id="broadcastControls">
                    <button onclick="broadcastAudioEl.play()">Play/Continue</button>
                    <button onclick="broadcastAudioEl.pause()">Pause</button>
                    <button onclick="resetBroadcastAudio()">Replay Audio</button>
                </div>
                <input type="text" id="broadcastInput" placeholder="Enter the broadcast content you hear">
                <button id="submitAnswer" onclick="submitAnswer()">Submit Answer</button>

                <div id="broadcastStatus" style="margin-top: 15px;"></div>
                <button class="controls" onclick="showModeSelection()">Return to Mode Selection</button>
            </div>
        </div>

        <div id="adminPanel" class="container hidden admin-section">
            <h2>âš™ï¸ ç®¡ç†å‘˜é…ç½®</h2>
            <p>ä¿®æ”¹å‚æ•°åè¯·ç‚¹å‡» **ä¿å­˜é…ç½®**ã€‚</p>

            <h3>çº¢ç»¿ç¯æ¨¡å¼é…ç½®</h3>
            <div id="trafficConfigInputs">
            </div>

            <h3>å¹¿æ’­æ¨¡å¼é…ç½®</h3>
            <label>éŸ³é¢‘è·¯å¾„ (URL/è·¯å¾„)ï¼š</label>
            <input type="text" id="broadcastAudioSrc" placeholder="broadcast_audio.mp3">
            <label>æ­£ç¡®ç­”æ¡ˆ (é€—å·åˆ†éš”)ï¼š</label>
            <input type="text" id="broadcastAnswers" placeholder="å¨æ–¯æ•æ–¯ç‰¹,Westminster">
            <label><input type="checkbox" id="broadcastFuzzyMatch"> å¼€å¯æ¨¡ç³ŠåŒ¹é… (å…è®¸è½»å¾®é”™åˆ«å­—)</label>

            <button onclick="saveAdminConfig()" style="background-color: #dc3545; margin-top: 20px;">ä¿å­˜é…ç½®</button>
            <button onclick="toggleAdminPanel()">è¿”å›æ¸¸æˆ</button>
        </div>
    </div>

    <audio id="gameAudio" preload="auto"></audio>
    <audio id="broadcastAudio" preload="auto" loop></audio>

    <script>// --- å…¨å±€å˜é‡å’Œåˆå§‹åŒ– ---
        const CONFIG_KEY = 'soundSignpostConfig';

        let currentTrafficLevel = null;

        // é»˜è®¤é…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„éŸ³é¢‘è·¯å¾„ï¼‰
        const DEFAULT_CONFIG = {
            trafficLight: {
                level1: { audioSrc: 'https://13833288559-cyber.github.io/audio/level1.mp3', targetStart: 30, targetEnd: 60, duration: 30 },
                level2: { audioSrc: 'https://13833288559-cyber.github.io/audio/level2.mp3', targetStart: 44, targetEnd: 64, duration: 30 },
                level3: { audioSrc: 'https://13833288559-cyber.github.io/audio/level3.mp3', targetStart: 45, targetEnd: 78, duration: 30 }
            },
            broadcast: {
                audioSrc: 'https://13833288559-cyber.github.io/audio/VO.wav',
                correctAnswers: ['weather', 'change', 'paddington'],
                fuzzyMatch: false
            }
        };

        let gameConfig = JSON.parse(localStorage.getItem(CONFIG_KEY)) || DEFAULT_CONFIG;
        let isTrafficGameActive = false;

        const audioEl = document.getElementById('gameAudio');
        const broadcastAudioEl = document.getElementById('broadcastAudio');
        const statusMessage = document.getElementById('statusMessage');
        const trafficActionButton = document.getElementById('trafficActionButton');

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šé¡µé¢åˆ‡æ¢ ---
        function hideAllSections() {
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('trafficLightMode').classList.add('hidden');
            document.getElementById('broadcastMode').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            audioEl.pause();
            broadcastAudioEl.pause();
            audioEl.onended = null;
        }

        function showModeSelection() {
            hideAllSections();
            document.getElementById('modeSelection').classList.remove('hidden');
            document.body.style.backgroundColor = '#f4f4f9';
        }

        function showTrafficLightMode() {
            hideAllSections();
            document.getElementById('trafficLightMode').classList.remove('hidden');
            document.getElementById('trafficLevelSelection').classList.remove('hidden');
            document.getElementById('trafficGame').classList.add('hidden');
            isTrafficGameActive = false;
            currentTrafficLevel = null;
        }

        function showBroadcastMode() {
            hideAllSections();
            document.getElementById('broadcastMode').classList.remove('hidden');
            // åˆå§‹åŒ–å¹¿æ’­éŸ³é¢‘æº
            broadcastAudioEl.src = gameConfig.broadcast.audioSrc;
            document.getElementById('broadcastStatus').textContent = 'Ready. Click Play to listen.';
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šçº¢ç»¿ç¯æ¨¡å¼ ---
        function startTrafficLightGame(level) {
            currentTrafficLevel = level;
            const config = gameConfig.trafficLight[level];

            document.getElementById('trafficLevelSelection').classList.add('hidden');
            document.getElementById('trafficGame').classList.remove('hidden');

            // è®¾ç½®éŸ³é¢‘æºå¹¶æ’­æ”¾
            audioEl.src = config.audioSrc;
            audioEl.currentTime = 0;

            // é‡æ–°ç»‘å®š Click to Pass é€»è¾‘
            trafficActionButton.onclick = attemptPass;

            // ç¡®ä¿æŒ‰é’®æ˜¯å¯ç”¨çš„ (å¦‚æœä¹‹å‰è¢«ç¦ç”¨)
            trafficActionButton.disabled = false;

            // å¿…é¡»åœ¨ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾éŸ³é¢‘ï¼Œè¿™é‡Œå‡å®šç”¨æˆ·ç‚¹å‡»äº†å…³å¡æŒ‰é’®
            audioEl.play().catch(e => {
                statusMessage.textContent = 'Browser restricted autoplay. Click "Click to Pass" to start!';
            });

            // ç¡®ä¿æ¸¸æˆçŠ¶æ€åœ¨å¼€å§‹æ—¶è¢«æ¿€æ´»
            isTrafficGameActive = true;

            statusMessage.textContent = 'Challenge started! Listen carefully.';
            statusMessage.className = '';

            trafficActionButton.textContent = 'Click to Pass';

            document.getElementById('currentAudioName').textContent = config.audioSrc.substring(0, 50) + '...';

            // è®¾ç½®éŸ³é¢‘æ’­æ”¾ç»“æŸè‡ªåŠ¨å¤±è´¥
            audioEl.onended = () => {
                if (isTrafficGameActive) {
                    handleTrafficResult(false, "Failed! Time ran out, you did not click in the allowed time.");
                }
            };
        }

        function attemptPass() {
            if (!currentTrafficLevel) return;

            if (!isTrafficGameActive) {
                // å¦‚æœéŸ³é¢‘æœªè‡ªåŠ¨æ’­æ”¾ï¼Œç¬¬ä¸€æ¬¡ç‚¹å‡»ç”¨äºå¯åŠ¨éŸ³é¢‘
                audioEl.play().catch(() => { });
                return;
            }

            const level = currentTrafficLevel;
            const config = gameConfig.trafficLight[level];
            const currentTime = audioEl.currentTime;

            audioEl.pause();
            isTrafficGameActive = false;

            let result = false;
            let message = '';

            if (currentTime >= config.targetStart && currentTime <= config.targetEnd) {
                result = true;
                message = `Success! Click time: ${currentTime.toFixed(2)}s (Target: ${config.targetStart}-${config.targetEnd}s)`;
            } else if (currentTime < config.targetStart) {
                message = `Failed! You clicked too early (${currentTime.toFixed(2)}s).`;
            } else {
                message = `Failed! You clicked too late (${currentTime.toFixed(2)}s).`;
            }

            handleTrafficResult(result, message);
        }

        function handleTrafficResult(success, message) {
            isTrafficGameActive = false;
            statusMessage.textContent = message;

            if (success) {
                // *** ä¿®å¤æˆåŠŸåæŒ‰é’®é€»è¾‘ ***
                trafficActionButton.disabled = false; // æˆåŠŸåå¿…é¡»è®¾ä¸ºå¯ç”¨ï¼Œè®©ç”¨æˆ·ç‚¹å‡»è¿”å›
                statusMessage.className = 'success';
                trafficActionButton.textContent = 'Success! Return to Mode Selection';
                document.body.style.backgroundColor = '#d4edda'; // Success background color
                trafficActionButton.onclick = showTrafficLightMode; // ç»‘å®šåˆ°è¿”å›å…³å¡é€‰æ‹©
            } else {
                // å¤±è´¥åé€»è¾‘ (å·²ä¿®å¤)ï¼šæŒ‰é’®è®¾ç½®ä¸ºå¯ç”¨ï¼Œå¹¶ç»‘å®šé‡æ–°æŒ‘æˆ˜å½“å‰å…³å¡
                trafficActionButton.disabled = false;
                statusMessage.className = 'failure';
                trafficActionButton.textContent = 'Failed! Challenge Again';
                document.body.style.backgroundColor = '#f8d7da'; // Failure background color
                trafficActionButton.onclick = () => startTrafficLightGame(currentTrafficLevel);
            }
            audioEl.onended = null; // ç§»é™¤ç›‘å¬å™¨
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå¹¿æ’­æ¨¡å¼ ---
        function resetBroadcastAudio() {
            broadcastAudioEl.pause();
            broadcastAudioEl.currentTime = 0;
            broadcastAudioEl.play().catch(e => {
                document.getElementById('broadcastStatus').textContent = 'Browser restricted autoplay. Click "Play/Continue" to start!';
            });
        }

        function submitAnswer() {
            const userInput = document.getElementById('broadcastInput').value;
            const config = gameConfig.broadcast;
            const normalizedInput = userInput.trim().toLowerCase();
            const normalizedAnswers = config.correctAnswers.map(ans => ans.toLowerCase());
            let broadcastStatus = document.getElementById('broadcastStatus');

            let isCorrect = false;

            // 1. ç²¾ç¡®åŒ¹é…
            if (normalizedAnswers.includes(normalizedInput)) {
                isCorrect = true;
            }

            // 2. æ¨¡ç³ŠåŒ¹é… (å¦‚æœå¼€å¯)
            if (!isCorrect && config.fuzzyMatch) {
                isCorrect = normalizedAnswers.some(ans => normalizedInput.includes(ans.toLowerCase().substring(0, 3)));
            }

            if (isCorrect) {
                broadcastAudioEl.pause();
                broadcastStatus.textContent = 'ğŸ‰ Success! You correctly identified the broadcast content!';
                broadcastStatus.className = 'success';
                document.getElementById('broadcastInput').disabled = true;
                document.getElementById('submitAnswer').disabled = true;
                document.body.style.backgroundColor = '#d4edda';
            } else {
                broadcastStatus.textContent = 'Try again! The entered content does not match.';
                broadcastStatus.className = 'failure';
                document.body.style.backgroundColor = '#f8d7da';
            }
        }


        // --- ç®¡ç†å‘˜åŠŸèƒ½ (ä¿ç•™ä¸­æ–‡) ---
        function toggleAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            const mainContent = document.getElementById('mainContent');

            if (adminPanel.classList.contains('hidden')) { // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
                hideAllSections();
                mainContent.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadAdminConfig();
            } else { // éšè—ç®¡ç†å‘˜é¢æ¿ï¼Œè¿”å›æ¸¸æˆ
                adminPanel.classList.add('hidden');
                mainContent.classList.remove('hidden');
                showModeSelection(); // åŠ è½½æ¨¡å¼é€‰æ‹©ç•Œé¢
            }
        }

        function loadAdminConfig() {
            // çº¢ç»¿ç¯é…ç½®åŠ è½½
            const trafficConfigDiv = document.getElementById('trafficConfigInputs');
            trafficConfigDiv.innerHTML = ''; // æ¸…ç©ºæ—§çš„è¾“å…¥
            const levels = ['level1', 'level2', 'level3'];
            levels.forEach(level => {
                const config = gameConfig.trafficLight[level];
                trafficConfigDiv.innerHTML += `
                            <h4>${level} å…³å¡</h4>
                            <label>éŸ³é¢‘è·¯å¾„ï¼š</label><input type="text" id="tl_${level}_src" value="${config.audioSrc}">
                            <label>å¼€å§‹ç§’æ•°ï¼š</label><input type="number" id="tl_${level}_start" value="${config.targetStart}">
                            <label>ç»“æŸç§’æ•°ï¼š</label><input type="number" id="tl_${level}_end" value="${config.targetEnd}">
                            <hr>
                        `;
            });

            // å¹¿æ’­é…ç½®åŠ è½½
            document.getElementById('broadcastAudioSrc').value = gameConfig.broadcast.audioSrc;
            document.getElementById('broadcastAnswers').value = gameConfig.broadcast.correctAnswers.join(', ');
            document.getElementById('broadcastFuzzyMatch').checked = gameConfig.broadcast.fuzzyMatch;
        }

        function saveAdminConfig() {
            // çº¢ç»¿ç¯é…ç½®ä¿å­˜
            const levels = ['level1', 'level2', 'level3'];
            levels.forEach(level => {
                gameConfig.trafficLight[level] = {
                    audioSrc: document.getElementById(`tl_${level}_src`).value,
                    targetStart: parseFloat(document.getElementById(`tl_${level}_start`).value) || 0,
                    targetEnd: parseFloat(document.getElementById(`tl_${level}_end`).value) || 0,
                    duration: 30 // ç®€åŒ–å¤„ç†ï¼Œæ—¶é•¿æœªä»éŸ³é¢‘è¯»å–
                };
            });

            // å¹¿æ’­é…ç½®ä¿å­˜
            gameConfig.broadcast = {
                audioSrc: document.getElementById('broadcastAudioSrc').value,
                correctAnswers: document.getElementById('broadcastAnswers').value.split(',').map(s => s.trim()).filter(s => s.length > 0),
                fuzzyMatch: document.getElementById('broadcastFuzzyMatch').checked
            };

            localStorage.setItem(CONFIG_KEY, JSON.stringify(gameConfig));
            alert('é…ç½®å·²æˆåŠŸä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼');
            toggleAdminPanel(); // è¿”å›æ¸¸æˆ
        }

        // --- åˆå§‹åŒ–å¯åŠ¨ ---
        window.onload = function () {
            loadAdminConfig(); // åŠ è½½é…ç½®ï¼Œå³ä½¿åœ¨åå°
            showModeSelection(); // æ˜¾ç¤ºä¸»èœå•
        };</script>
</body>
</html>